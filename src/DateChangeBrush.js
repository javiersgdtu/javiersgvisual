var div=d3.select("#selectdiv"),margin={top:20,right:20,bottom:30,left:50},width=1200-margin.left-margin.right,height=500-margin.top-margin.bottom,margin2={top:430,right:20,bottom:30,left:40},height2=500-margin2.top-margin2.bottom,parseDate=d3.timeParse("%Y-%m-%d"),FormatDate=d3.timeFormat("%B-%Y"),svg=d3.select(".container").append("div").attr("class","divgraph").style("width","80%").append("svg").attr("viewBox",[0,0,width+margin.left+margin.right,height+height2+margin.top+margin.bottom+margin2.bottom]).append("g").attr("transform","translate("+margin.left+","+margin.top+")");svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height);var x=d3.scaleTime().range([0,width]),x2=d3.scaleTime().range([0,width]),y=d3.scaleLinear().range([height,0]),y2=d3.scaleLinear().range([height2,0]),xAxis=d3.axisBottom(x),xAxis2=d3.axisBottom(x2),yAxis=d3.axisLeft(y),tooltip=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),baseline=d3.line().x((function(t){return x(t.Date)})).y((function(t){return 0!=t.Treshold?y(t.Treshold):2*height})),area=d3.area().curve(d3.curveMonotoneX).x((function(t){return x(t.Date)})).y0((function(t){return y(t.n)})).y1(height),area2=d3.area().x((function(t){return x2(t.Date)})).y0(height2).y1((function(t){return y2(t.n)})),defs=svg.append("defs"),greenGrad=defs.append("linearGradient").attr("id","greenGrad").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%");greenGrad.append("stop").attr("offset","0%").attr("stop-color","white"),greenGrad.append("stop").attr("offset","75%").attr("stop-color","green");var redGrad=defs.append("linearGradient").attr("id","redGrad").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%");redGrad.append("stop").attr("offset","0%").attr("stop-color","white"),redGrad.append("stop").attr("offset","100%").attr("stop-color","red");var dataFiltered={},dataNested={};d3.csv("/assets/data/MorbiditygRandom.csv",(function(t,a){if(t)throw t;a.forEach((function(t){t.Date=parseDate(t.Date),t.Month=FormatDate(t.Date),t.n=+t.n,t.baseline=+t.baseline,t.Treshold=+t.Treshold,t.Disease=t.Disease}));var e=d3.brushX().extent([[0,0],[width,height2]]).on("brush end",(function(){if(!d3.event.sourceEvent||"zoom"!==d3.event.sourceEvent.type){var t=d3.event.selection||x2.range();x.domain(t.map(x2.invert,x2)),n.select(".axis--x").call(xAxis),svg.select(".green_zoom").attr("d",area),svg.select(".red_zoom").attr("d",area),svg.selectAll("circle").attr("cx",(function(t){return x(t.Date)})).attr("cy",(function(t){return y(t.n)})),svg.select(".zoom").call(r.transform,d3.zoomIdentity.scale(width/(t[1]-t[0])).translate(-t[0],0))}})),r=d3.zoom().scaleExtent([1,1/0]).translateExtent([[0,0],[width,height]]).extent([[0,0],[width,height]]).on("zoom",(function(){if(!d3.event.sourceEvent||"brush"!==d3.event.sourceEvent.type){var t=d3.event.transform;x.domain(t.rescaleX(x2).domain()),n.select(".axis--x").call(xAxis),svg.select(".green_zoom").attr("d",area),svg.select(".red_zoom").attr("d",area),svg.selectAll("circle").attr("cx",(function(t){return x(t.Date)})).attr("cy",(function(t){return y(t.n)})),i.select(".brush").call(e.move,x.range().map(t.invertX,t))}})),n=svg.append("g").attr("class","focus"),i=svg.append("g").attr("class","context").attr("transform","translate(0,"+margin2.top+")"),s=d3.nest().key((function(t){return t.Disease})).entries(a);div.append("select").attr("id","letiableSelect").on("change",(function(){var t,a=this.value,e=s.filter((function(t){return t.key===a})),r=d3.max(e[0].values,(function(t){return t.n})),o=d3.max(e[0].values,(function(t){return t.Treshold}));t=r>o?[d3.min(e[0].values,(function(t){return t.n})),r]:[d3.min(e[0].values,(function(t){return t.n})),o],y.domain(d3.extent(t)),y2.domain(d3.extent(t)),d3.min(e[0].values,(function(t){return t.Treshold}))>=d3.min(e[0].values,(function(t){return t.n}))?g.datum(e[0].values).transition().duration(1e3).attr("d",baseline):g.datum(0).transition().duration(1e3).attr("d",baseline),n.select(".axis--x").transition().duration(1e3).call(xAxis),n.select(".axis--y").transition().duration(1e3).call(yAxis),svg.selectAll("circle").data(e[0].values).transition().duration(1e3).attr("cx",(function(t){return x(t.Date)})).attr("cy",(function(t){return y(t.n)})),u.data(e[0].values).transition().duration(1e3).attr("id","clip-above").attr("width",width).attr("height",(function(t){return y(t.Treshold)})),p.data(e[0].values).transition().duration(1e3).attr("id","clip-below").attr("y",(function(t){return 0!=t.Treshold?y(t.Treshold):0})).attr("width",width).attr("height",height),h.datum(e[0].values).transition().duration(1e3).attr("d",area).attr("class","red_zoom"),m.datum(e[0].values).transition().duration(1e3).attr("d",area).attr("class","green_zoom"),i.select(".area_sec").datum(e[0].values).transition().duration(1e3).attr("d",area2)})).selectAll("option").data(s).enter().append("option").attr("value",(function(t){return t.key})).text((function(t){return t.key}));var o,d=s.filter((function(t){return t.key===d3.select("#letiableSelect").property("value")})),l=d3.max(d[0].values,(function(t){return t.n})),c=d3.max(d[0].values,(function(t){return t.Treshold}));o=l>c?[d3.min(d[0].values,(function(t){return t.n})),l]:[d3.min(d[0].values,(function(t){return t.n})),c],x.domain(d3.extent(d[0].values,(function(t){return t.Date}))),x2.domain(d3.extent(d[0].values,(function(t){return t.Date}))),y.domain(o),y2.domain(o);var u=defs.append("clipPath").data(d[0].values).attr("id","clip-above").append("rect").attr("width",width).attr("height",(function(t){return y(t.Treshold)})),p=defs.append("clipPath").data(d[0].values).attr("id","clip-below").append("rect").attr("y",(function(t){if(0!=t.Treshold)return y(t.Treshold)})).attr("width",width).attr("height",height),h=svg.append("path").datum(d[0].values).attr("clip-path","url(#clip-above)").attr("d",area).attr("class","area red_zoom").style("fill","url(#redGrad)"),m=svg.append("path").datum(d[0].values).attr("clip-path","url(#clip-below)").attr("d",area).attr("class","area green_zoom").style("fill","url(#greenGrad)");h.datum(d[0].values).attr("d",area).attr("class","red_zoom"),m.datum(d[0].values).attr("d",area).attr("class","green_zoom");var g=svg.append("path").datum(d[0].values).attr("class","dashline").attr("d",baseline);svg.selectAll("circle").data(d[0].values).enter().append("circle").attr("stroke","black").attr("fill","white").attr("r",3.5).attr("cx",(function(t){return x(t.Date)})).attr("cy",(function(t){return y(t.n)})).on("mouseover",(function(t,a){d3.select(this).transition().duration(1e3).attr("r",10).attr("fill","orange").attr("stroke-dasharray","10,3"),tooltip.transition().duration(200).style("opacity",.9),tooltip.html(t.n+"<br/>patients. Date: "+FormatDate(t.Date)).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-28+"px")})).on("mouseout",(function(t){d3.select(this).transition().duration(500).attr("r",3.5).attr("fill","white").attr("stroke-dasharray","100,30"),tooltip.transition().duration(500).style("opacity",0)})),n.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+height+")").call(xAxis),n.append("text").attr("transform","rotate(0)").attr("x",width-margin.right).attr("y",height+margin.bottom-10).style("font-size","13px").text("Date"),n.append("g").attr("class","axis axis--y").call(yAxis),n.append("text").attr("transform","rotate(-90)").attr("y",12).attr("dy",".71em").style("text-anchor","end").style("font-size","11px").text("Number of patients"),i.append("path").datum(d[0].values).attr("transform","translate(0,60)").attr("class","area area_sec").attr("d",area2),i.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+(height2+margin2.bottom+margin.bottom)+")").call(xAxis2),i.append("g").attr("class","brush").call(e).attr("transform","translate(0,60)").call(e.move,x.range()),svg.append("rect").attr("class","zoom").attr("width",width).attr("height",height).attr("transform","translate("+margin.left+","+margin.top+")").call(r)}));var legend=d3.select(".container").append("div").attr("class","divtext");legend.html("<p class='wb-stl-special'>Time Chart of Patients medical conditions.<br><br> <span style='font-size:12.5px;'> Monitoring of medical conditions. Every condition has a different threshold. Above it, the condition is considered viral. Made with D3.</span></p>");