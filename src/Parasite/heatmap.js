var scroller_heat=scrollama(),slidename="fm_occupancy";function drawHeatMap(t){scroller_heat.setup({step:".step-insights",offset:.5,debug:!1}).onStepEnter(m);new Set(t.map(t=>t.scene)),new Set(t.map(t=>t.dt_sub));var e=d3.select("#heatmap-svg").append("g").attr("transform","translate(150,50)");e.append("g").attr("id","characters-bar");var a=e.append("image").attr("x",550).attr("y",1250).attr("transform","rotate(-30) scale(0.4)").attr("href","images/touch.svg"),r=t.filter((function(t){return t.slide==slidename})),n=r.map((function(t){return t.level})),i=d3.scaleBand([0,500]).domain(["Park","Kim","Geun Se & Moon Gwang"]),c=d3.scaleBand([250,0]).domain(n),l=d3.scaleLinear(["#f7e8ff","#db3535"]).domain([0,100]),s=d3.axisBottom(i),d=d3.axisLeft(c);e.append("g").attr("id","axisY").call(d).call(t=>t.select(".domain").remove()),e.append("g").attr("id","axisX").attr("transform","translate(0,250)").call(s).call(t=>t.select(".domain").remove());var o=e.append("defs").append("linearGradient").attr("id","gradient-legend");o.attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%"),o.append("stop").attr("offset","0%").attr("stop-color","#db3535"),o.append("stop").attr("offset","100%").attr("stop-color","#f7e8ff");var p=e.append("g").attr("id","heatmap"),u=i.bandwidth(),f=c.bandwidth();p.append("g").attr("id","legend").append("rect").attr("x",540).attr("y",150).attr("width",20).attr("height",100).style("stroke-width",4).style("stroke","none").style("opacity",.8).attr("fill","url(#gradient-legend)"),p.select("#legend").append("text").attr("x",565).attr("y",150).text("100 %"),p.select("#legend").append("text").attr("x",565).attr("y",250).text("0 %");var h=p.append("g").attr("class","character-heatmap").selectAll("circle").data(characters_leg).enter().append("circle").attr("r",radius).attr("cx",(function(t,e){return t.idx=e,e>=4&&e<=7?(offsetfam=0,t.idx=e-4):e>=0&&e<=3?(offsetfam=40,t.idx=e+4):e>7&&(offsetfam=80),offsetfam+40*t.idx})).attr("cy",(function(){return 310})).attr("fill",(function(t,e){return colorCharacter(t.Character)}));function m(t){0==t.index&&y("fm_occupancy"),3==t.index?y("fm_updown"):4==t.index?y("fm_static"):5==t.index&&y("fm_move")}function y(s){r=t.filter((function(t){return t.slide==s})),n=r.map((function(t){return t.level})),c.domain(n),f=c.bandwidth(),e.selectAll("#g-rect").remove(),e.selectAll(".text-heat").remove(),e.selectAll("[id^=g-rect-ch]").remove(),e.selectAll("[id^=g-text-ch]").remove(),e.selectAll("#axisY").transition().duration(500).call(d).call(t=>t.select(".domain").remove());p.append("g").attr("id","g-rect").selectAll("rect").data(r).enter().append("rect").attr("id",(t,e)=>"rect-"+t.family.substring(0,3)+e).attr("class","rect-heat").attr("x",(function(t){return i(t.family)})).attr("y",t=>c(t.level)).attr("width",u).attr("height",f).attr("rx",10).attr("ry",10).style("stroke-width",4).style("stroke","none").style("opacity",0).attr("fill",(function(t){return l(t.pct)})).on("mouseover",(function(){d3.select(this).raise().transition("tr-rect-heat-in").duration(1e3).style("stroke","black").style("opacity",1),d3.select("#text-"+d3.select(this).attr("id")).transition().duration(500).attr("opacity",1)})).on("mouseout",(function(){d3.select("#text-"+d3.select(this).attr("id")).transition().duration(500).attr("opacity",0),d3.select(this).transition("tr-rect-heat-out").duration(1e3).style("stroke","none")}));p.selectAll(".rect-heat").transition().ease(d3.easeBounce).delay((function(t,e){return 100*e})).duration(1e3).style("opacity",.9),p.append("g").attr("class","text-heat").selectAll("text").data(r).enter().append("text").attr("id",(t,e)=>"text-rect-"+t.family.substring(0,3)+e).attr("x",(function(t){return i(t.family)+u/2-10})).attr("y",t=>c(t.level)+f/2).text((function(t){return t.pct+" %"})).style("font-size","26px").attr("opacity",0).style("pointer-events","none"),h.on("mouseover",(function(r,n){a.transition().duration(2e3).style("visibility","hidden"),d3.select(this).transition().duration(1e3).ease(d3.easeLinear).attr("r",2*radius).attr("stroke",d3.select(this).attr("fill")).attr("stroke-width",15).attr("stroke-dasharray",10).style("z-index",100),p.append("g").attr("id","character-legendheat").attr("transform","translate(-20,55)").append("text").attr("x",d3.select(this).attr("cx")).attr("y",d3.select(this).attr("cy")).text(n.Character),function(a){var r=a.Family.substring(0,3);e.selectAll("[id^='rect-"+r+"']").transition().style("opacity",0);var n=t.filter((function(t){return t.slide=="ch_"+s.substr(3)&&t.family.match(r)})),l=[...new Set(n.map(t=>t.character))],d=d3.scaleBand([0,f]).domain(l).padding(.1),o=d3.scaleLinear([0,u-60]).domain([0,100]);if(e.select("#characters-bar").selectAll("#g-rect-ch"+r).empty()){e.select("#characters-bar").append("g").attr("id","g-rect-ch"+r).selectAll("rect").data(n).enter().append("rect").attr("id",(t,e)=>t.character+t.level).attr("x",(function(t){return i(t.family)+5})).attr("y",(function(t,e){return c(t.level)+d(t.character)})).attr("height",(function(t){return d.bandwidth()})).attr("width",(function(t){return o(0)})).attr("fill",t=>colorCharacter(t.character)).attr("rx",5).attr("opacity",.8).transition().duration(1e3).attr("width",(function(t){return o(t.pct)}))}if(e.select("#characters-bar").selectAll("#g-text-ch"+r).empty()){e.select("#characters-bar").append("g").attr("id","g-text-ch"+r).selectAll("text").data(n).enter().append("text").attr("id",(t,e)=>"text"+t.character+t.level).attr("x",(function(t){return i(t.family)+o(0)+6})).attr("y",(function(t,e){var a=d.bandwidth()>20?d.bandwidth()/1.5:d.bandwidth();return c(t.level)+d(t.character)+a})).text(t=>t.pct+"%").transition().duration(1e3).attr("x",(function(t){return i(t.family)+o(t.pct)+6}))}}(n),e.selectAll("[id^='"+n.Character+"']").attr("stroke","black").attr("stroke-dasharray",4).attr("opacity",1)})).on("mouseout",(function(t,a){var r=a.Family.substring(0,3);e.selectAll("[id^='rect-"+r+"']").transition().duration(500).style("opacity",1),d3.select("#character-legendheat").remove(),d3.select(this).transition().duration(1e3).attr("r",radius).attr("stroke-width",0),e.selectAll("[id^='"+a.Character+"']").attr("stroke","none").attr("opacity",.9)}))}}d3.json("data/data_out/heatmap.json").then((function(t){drawHeatMap(t)}));