<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Trendline</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>

</head>

<body>

    <div></div>
    <script>
        //API data. So far using static file.
        var api = '../Output-Analytics.json';


        function parserData(data) {
            /*  var bpi = data.bpi;
                var arr = [];
                for (let key in bpi) {
                    arr.push({
                        date: new Date(key),
                        value: bpi[key],
                    });
                }
                return arr;*/
        }

        d3.json(api)
            .then((data) => {
                console.log(data)
                var trend_data = data.aggregations.hits_over_time.buckets
                console.log(trend_data)
                var formatdate = d3.utcParse("%Y-%m-%dT%H:%M:%S.%f%Z")

                trend_data.forEach(function(d) {

                    d.key_as_string = formatdate(d.key_as_string)
                })

                //   var parser = parserData(data);
                //console.log(parser)
                console.log(trend_data)

                drawChart(trend_data);
            })
            .catch((error) => {
                console.log('error', error);
            });

        function drawChart(parser) {
            var width = 600;
            var height = 400;

            var svg = d3.select('div')
                .append('svg')
                .attr('width', width + 100)
                .attr('height', height + 100)
                .append('g')
                .attr('transform', 'translate(40, 20)');



            // Tooltip
            var tooltip = d3.select("div").append("div")
                .attr("class", "tooltip")


            //console.log(d3.extent(parser, (d) => d.value))
            var scaleY = d3.scaleLinear()
                .domain(d3.extent(parser, (d) => d.doc_count))
                .range([height, 0]);
            console.log(d3.extent(parser, (d) => d.key_as_string))

            var scaleX = d3.scaleTime()
                .domain(d3.extent(parser, (d) => d.key_as_string))
                .range([0, width])

            var area = d3.area()
                .curve(d3.curveMonotoneX)
                .x(d => scaleX(d.key_as_string))
                .y0(scaleY(30))
                .y1(d => scaleY(d.doc_count));

            var line = d3.line()
                .curve(d3.curveMonotoneX)
                .x(d => scaleX(d.key_as_string))
                .y(d => scaleY(d.doc_count));


            var pathArea = svg.append('path');
            var pathLine = svg.append('path');


            pathArea
                .attr('fill', '#d5e4ffff')
                .attr('stroke', 'none')
                .attr('d', area(parser));

            pathLine
                .attr('fill', 'none')
                .attr('stroke', '#005AFF')
                .attr('stroke-width', 2)
                .attr('d', line(parser));
            var formatdate_x = d3.timeFormat("%B - %Y")

            var axisX = d3.axisBottom(scaleX).tickFormat(formatdate_x) //.ticks(5);
            var axisY = d3.axisLeft(scaleY) //.ticks(4);

            // Y axis
            svg.append('g')
                .attr('class', 'axisY')
                //.attr('transform', 'translate(40, 0)')
                .call(axisY)

            //X axis
            svg.append('g')
                .attr('class', 'axisX')
                .attr('transform', `translate(0, ${height})`)
                .call(axisX);

            // Title X axis
            svg.append("text")
                .attr('class', 'textAxis')
                .attr("transform",
                    "translate(" + (width / 2) + " ," +
                    (height + 60) + ")")
                .style("text-anchor", "middle")
                .text("Date");

            // Title Y axis
            svg.append("text")
                .attr('class', 'textAxis')
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("dx", -35)
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Counts");

            var circles = svg.selectAll('circle')
                .data(parser)
                .enter()
                .append('circle')
                .attr('cx', (d) => scaleX(d.key_as_string))
                .attr('cy', (d) => scaleY(d.doc_count))
                .attr('r', 4)
                .attr('fill', "#005AFF")
                .attr('stroke', "white")
                .attr('stroke-width', 2)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                // .on("click", update);




            /*   function update(event, d) {
                   scaleY.domain([9000, 9200])
                       //scaleY.domain([9000, d.value]); //o usando el valor del circle

                   d3.selectAll(".axisY").transition().duration(1000)
                       .call(axisY);
               }*/

            function handleMouseOver(event, d) {
                d3.select(this)
                    .transition()
                    .duration(1000)
                    .attr("fill", "#F9E254")
                    .attr("r", 6)

                //Para formatear DateTimes
                var formatdate = d3.timeFormat("%B %d")

                tooltip.transition()
                    .duration(200)
                    .style("visibility", "visible")
                    // .style("opacity", .9)
                    .style("left", (event.pageX + 20) + "px")
                    .style("top", (event.pageY - 30) + "px")
                    .text(`${formatdate(d.key_as_string)}- Count: ${d.doc_count}`)

            }

            function handleMouseOut(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr("fill", "#005AFF")
                    .attr("r", 4)


                tooltip.transition()
                    .duration(200)
                    .style("visibility", "hidden")

            }


        };
    </script>
</body>

</html>