<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../style.css">
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>

    <div></div>

    <script>
        //API data. So far using static file.
        var api = '../../Output-Analytics.json';


        function parserData(data) {

            var f = d3.format(".1f");
            var total = d3.sum(data, function(d) {
                return d.doc_count;
            });

            data.forEach((d) => {
                d.percentage = +f(100 * (d.doc_count / total))
                d.key = d.key.substring(d.key.indexOf("##") + 2)
            })
            return data;
        }

        d3.json(api)
            .then((data) => {
                console.log(data)
                var sentiment_data = data.aggregations.sentiment.buckets
                var parser = parserData(sentiment_data);
                console.log(parser)
                drawChart(parser);
            })
            .catch((error) => {
                console.log('error', error);
            });


        function drawChart(data) {

            var width = 500;
            var height = 500;
            var ratio = d3.min([width, height]) / 2
            var outerR = 10;

            var svg = d3.select('div')
                .append('svg')
                .attr('width', width + 50)
                .attr('height', height + 50)
                .append("g")
                .attr('transform', `translate(${ratio+outerR}, ${ratio+outerR})`);

            // Tooltip
            /*var tooltip = d3.select("div").append("div")
                .attr("class", "tooltip");*/


            //console.log(input)
            //-----------------------------
            console.log(data)
            var pie = d3.pie().value(d => d.percentage);
            var dataPie = pie(data);
            console.log(dataPie)

            var arc = d3.arc()
                .innerRadius(100)
                .padAngle(0.02)

            .outerRadius(ratio);

            //Arc created to handle the transition
            var arcmouse = d3.arc()
                .innerRadius(120)
                .padAngle(0.03)
                .outerRadius(ratio + outerR);


            var pathPie = svg
                .selectAll('path')
                .data(dataPie)
                .enter()
                .append('path')
                .attr('d', arc);

            var scaleColor = d3.scaleOrdinal(["#22DB8E", "#E30806", "#E7EBED"])
                .domain(["Positive", "Negative", "Neutral"])

            pathPie.attr('fill', (d) => {
                    return scaleColor(d.data.key);
                })
                .attr("fill-opacity", 0.3)
                .attr("stroke", (d) => {
                    return scaleColor(d.data.key);
                })
                .attr("stroke-width", "2px")
                .attr("stroke-opacity", 1)


            .on("mouseover", function() {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr('d', arcmouse)
                })
                .on("mouseout", function() {
                    d3.select(this).transition()
                        .duration(0).attr('d', arc)
                });


            var text = svg.selectAll('text')
                .data(dataPie)
                .enter()
                .append('text')
                .attr('x', (d) => {
                    d.center = arc.centroid(d);
                    //console.log(d.center)
                    return d.center[0] - 10;
                })
                .attr('y', (d) => {
                    return d.center[1];
                })

            .attr("fill", d => scaleColor(d.data.key))
                .attr("font-weight", "bold")
                .text(d => d.data.percentage + " %")

            //Add text html
            d3.select('div')
                .append('div')
                .style("position", "absolute")
                .style("left", (ratio) + "px")
                .style("top", (ratio) + "px")
                .html("<span style='color: #22DB8E;'>Positive</span></br> <span style='color: #E7EBED;'>Neutral</span></br> <span style='color: #E30806;'>  Negative</span>")


        }
    </script>
</body>

</html>